(async function(){const {jsPDF}=window.jspdf;function safe(k){try{const v=localStorage.getItem(k);return v?JSON.parse(v):null}catch(e){return null}};function coletar(){const perfil=safe('calor_profile')||safe('userProfile')||{};const refeicoes=safe('calor_meals')||safe('meals')||[];const hist=safe('calor_history')||{};const pesquisas=safe('calor_searches')||[];const altura=perfil.altura_cm||perfil.height_cm||175;const peso=perfil.peso_kg||perfil.weight_kg||80;const imc=((peso/Math.pow((altura/100),2))||0).toFixed(2);return{perfil:{nome:perfil.nome||perfil.name||'Usuário CalorIA',idade:perfil.idade||perfil.age||30,sexo:perfil.sexo||perfil.gender||'Não informado',altura_cm:altura,peso_kg:peso},resumo:{imc,tmb:perfil.tmb||'—',gordura_pct:perfil.gordura_pct||'—',massa_magra:perfil.massa_magra||'—'},refeicoes,hum:hist,pesquisas,gerado_em:new Date().toLocaleString()}};async function renderChart({labels,datasets,width=800,height=240}){const c=document.createElement('canvas');c.width=width;c.height=height;c.style.display='none';document.body.appendChild(c);const ctx=c.getContext('2d');const chart=new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:false,plugins:{legend:{display:true}}}});await new Promise(r=>setTimeout(r,200));const url=c.toDataURL('image/png',0.9);chart.destroy();c.remove();return url}async function gerar({lang='pt',styleMode='both'}={}){const dados=coletar();const doc=new jsPDF({unit:'pt',format:'a4'});const W=doc.internal.pageSize.getWidth();const margin=36;try{doc.addImage('/icon-192x192.png','PNG',(W/2)-40,30,80,80)}catch(e){}doc.setFontSize(18);doc.text('Relatório CalorIA - Profissional',W/2,140,{align:'center'});doc.setFontSize(10);doc.text('Gerado em: '+dados.gerado_em,W/2,160,{align:'center'});doc.setFontSize(12);doc.text('Dados Básicos',margin,200);doc.setFontSize(10);doc.text('Nome: '+dados.perfil.nome,margin,220);doc.text('Idade: '+dados.perfil.idade+' • Sexo: '+dados.perfil.sexo,margin,235);doc.text('Altura: '+dados.perfil.altura_cm+' cm • Peso: '+dados.perfil.peso_kg+' kg',margin,250);let y=280;doc.setFontSize(12);doc.text('Composição Corporal',margin,y);y+=18;doc.setFontSize(10);doc.text('IMC: '+dados.resumo.imc,margin,y);y+=14;doc.text('TMB: '+dados.resumo.tmb,margin,y);doc.addPage();doc.setFontSize(14);doc.text('Nutrição - Calorias e Macro por Refeição',margin,40);doc.setFontSize(10);const mealRows=(dados.refeicoes&&dados.refeicoes.length)?dados.refeicoes.map((r,idx)=>[idx+1,r.nome||r.title||('Refeição '+(idx+1)),r.hora||r.time||'-',r.calorias!=null?r.calorias:'-',r.carboidratos!=null?r.carboidratos:'-',r.proteinas!=null?r.proteinas:'-',r.gorduras!=null?r.gorduras:'-']):[['-','Nenhuma refeição registrada','','','','','']];doc.autoTable({head:[['#','Refeição','Hora','kcal','Carbs(g)','Protein(g)','Fat(g)']],body:mealRows,startY:60,margin:{left:margin,right:margin},styles:{fontSize:9},theme:'striped'});doc.addPage();doc.text('Treino e Gasto Estimado',margin,40);doc.autoTable({head:[['#','Tipo','Freq. Semanal','Gasto (kcal)']],body:[['-','Nenhum treino registrado','','']],startY:60,margin:{left:margin,right:margin}});const series=(dados.hum&&dados.hum.series)||{labels:['T1','T2','T3','T4'],data:[80,79.5,79,78.5]};const chartImg=await renderChart({labels:series.labels,datasets:[{label:'Peso (kg)',data:series.data,borderColor:'rgb(255,99,71)'}],width:800,height:240});doc.addPage();doc.text('Progresso e Evolução',margin,40);doc.addImage(chartImg,'PNG',margin,70,W-margin*2,200);doc.addPage();doc.text('Observações e Recomendações (IA)',margin,40);const recs=JSON.parse(localStorage.getItem('calor_recommendations')||'[]');if(recs.length){recs.forEach((r,i)=>{doc.text('- '+r,margin,70+i*14)})}else{doc.text('Nenhuma recomendação automática disponível.',margin,70)}doc.addPage();doc.text('Anexos & Histórico',margin,40);const searches=dados.pesquisas||[];if(searches.length){const rows=searches.slice(0,50).map((s,i)=>[i+1,s.q||s.query||'-',new Date(s.at||Date.now()).toLocaleString()]);doc.autoTable({head:[['#','Busca','Quando']],body:rows,startY:60,margin:{left:margin,right:margin},styles:{fontSize:8}})}else{doc.text('Sem histórico de buscas gravado.',margin,60)}const name=`CalorIA_Relatorio_${(new Date()).toISOString().slice(0,10)}.pdf`;doc.save(name);try{const blob=doc.output('blob');return{success:true,blob,filename:name}}catch(e){return{success:true,filename:name}}}window.gerarRelatorioPDF=gerar;console.log('report loaded')})();